
<br />

<div class="booyah-box col-xs-10 col-xs-offset-1">
  <div class="chessboard" data-pieces-url="<%= game_pieces_path(@game) %>">
    <% (0..7).each do |row| %>
      <% (0..7).each do |col| %>
        <div class="square <%= (row + col) % 2 == 0 ? "light" : "dark" %>"
          id="<%= row.to_s + col.to_s %>"></div>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  var whitePieceHtml = {
    King: '&#9812;',
    Queen: '&#9813;',
    Rook: '&#9814;',
    Bishop: '&#9815;',
    Knight: '&#9816;',
    Pawn: '&#9817;'
  };
  var blackPieceHtml = {
    King: '&#9818;',
    Queen: '&#9819;',
    Rook: '&#9820;',
    Bishop: '&#9821;',
    Knight: '&#9822;',
    Pawn: '&#9823;'
  };

  $(function() {
    $('.chessboard').each(function() {
      var $chessboard = $(this);
      var piecesURL = $chessboard.data('pieces-url');

      // populates boards with pieces
      $.get(piecesURL).success(function(pieces) {
        pieces.forEach(function(piece, i){
          if (!piece.is_captured) {
            placePiece(piece);
          }
        });
      });

      $(".square").droppable({
        // if (moveIsInvalid) $( "#draggable" ).draggable({ revert: "valid" });
        drop: function(event, ui) {
          var piece = $(ui.draggable);
          $(this).append(piece);
          piece.css({left: 0, top: 0});
          movePiece(piece);
        }
      });

      function placePiece(piece) {
        var squareId = String(piece.row) + String(piece.col);
        var pieceHtml = "";
        if (piece.is_black) {
          pieceHtml = blackPieceHtml[piece.type];
        } else {
          pieceHtml = whitePieceHtml[piece.type];
        }

        var piece = $.parseHTML(
          '<div class="piece" data-id='+ piece.id +'>' + pieceHtml + '</div>');

        $chessboard.find('.square#'+squareId).append(piece);
        $chessboard.find('.piece').draggable();
      }

      function movePiece(piece) {
        var coord = piece.closest('.square').attr('id');
        var newRow = coord[0];
        var newCol = coord[1];

        $.post(piecesURL + "/" + piece.data("id"), {
          _method: "PUT",
          piece: { row: newRow, col: newCol }
        }).success();
      }
    });
  });
</script>
